parameters:
  ServiceConnection:
  Environment:
  OverrideBlockOnPossibleDataLoss: false

jobs:
  - deployment: DeployWebApp
    pool:
      name: DAS - Continuous Deployment Agents
    environment: ${{ parameters.Environment }}
    strategy:
      runOnce:
        deploy:
          steps:
            - template: azure-pipelines-templates/deploy/step/wait-azure-devops-deployment.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                EnvironmentId: $(Environment.Id)
                PipelineName: $(Build.DefinitionName)
                RunId: $(Build.BuildId)
            - template: azure-pipelines-templates/deploy/step/set-backendaccessrestrictions-variable.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                SharedEnvResourceGroup: $(SharedEnvResourceGroup)
                SharedEnvVirtualNetworkName: $(SharedEnvVirtualNetworkName)
                BackEndAccessRestrictionsExcludedSubnets: $(BackEndAccessRestrictionsExcludedSubnets)
                ResourceEnvironmentName: $(ResourceEnvironmentName)
                UnrestrictedEnvironments: $(UnrestrictedEnvironments)
                UptimeMonitoringAccessRestrictions: $(UptimeMonitoringAccessRestrictions)
            - template: azure-pipelines-templates/deploy/step/arm-deploy.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                SubscriptionId: $(SubscriptionId)
                Location: $(ResourceGroupLocation)
                Environment: ${{ parameters.Environment }}
                TemplatePath: $(Pipeline.Workspace)/$(SolutionBaseName)/azure/template.json
                ParametersPath: $(Pipeline.Workspace)/$(SolutionBaseName)/azure/template.parameters.json
                IsMultiRepoCheckout: true
                TemplateSecrets:
                  LoggingRedisConnectionString: $(LoggingRedisConnectionString)
                  ConfigurationStorageConnectionString: $(ConfigurationStorageConnectionString)
                  SharedStorageAccountConnectionString: $(SharedStorageAccountConnectionString)
            - task: AzurePowerShell@5
              displayName: "Add IP Whitelist"
              inputs:
                azureSubscription: ${{ parameters.ServiceConnection }}
                ScriptType: "FilePath"
                ScriptPath: "$(Pipeline.Workspace)/$(SolutionBaseName)/azure/Add-IpToWhitelist.ps1"
                ScriptArguments: "-ResourceGroupName '$(ResourceGroupName)' -WebAppName '$(AppServiceName)' -IpAddress '$(WhitelistedIpAddress)'"
                azurePowerShellVersion: "LatestVersion"
            - template: azure-pipelines-templates/deploy/step/get-apim-subscription-key.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                ApimResourceGroup: $(SharedApimResourceGroup)
                ApimName: $(SharedApimName)
                SubscriptionId: $(FunctionAppName)
                PipelineVariableName: RoatpCourseManagementApimSubscriptionKey
                IsMultiRepoCheckout: true
            - template: azure-pipelines-templates/deploy/step/generate-config.yml@das-platform-building-blocks
              parameters:
                EnvironmentName: $(EnvironmentName)
                ServiceConnection: ${{ parameters.ServiceConnection }}
                SourcePath: $(Pipeline.Workspace)/das-employer-config/Configuration/das-roatp-api
                StorageAccountName: $(ConfigurationStorageAccountName)
                StorageAccountResourceGroup: $(SharedEnvResourceGroup)
                TargetFileName: "*.schema.json"
                TableName: Configuration
                ConfigurationSecrets:
                  RoatpCourseManagementApimSubscriptionKey: $(RoatpCourseManagementApimSubscriptionKey)
            - template: azure-pipelines-templates/deploy/step/sql-dacpac-deploy.yml@das-platform-building-blocks
              parameters:
                AzureSubscription: ${{ parameters.ServiceConnection }}
                ServerName: $(SharedSQLServerFQDN)
                SqlUsername: $(SharedSQLServerUsername)
                DacpacFile: $(Pipeline.Workspace)/DacpacArtifact/src/$(SolutionBaseName).Database/bin/Output/$(SolutionBaseName).Database.dacpac
                DatabaseName: $(DatabaseName)
                OverrideBlockOnPossibleDataLoss: ${{ parameters.OverrideBlockOnPossibleDataLoss }}
                Environment: ${{ parameters.Environment }}
            - template: azure-pipelines-templates/deploy/step/app-deploy.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                AppServiceName: $(AppServiceName)
                DeploymentPackagePath: $(Pipeline.Workspace)/$(SolutionBaseName)/$(SolutionBaseName).Api.zip
            - template: azure-pipelines-templates/deploy/step/function-deploy.yml@das-platform-building-blocks
              parameters:
                ServiceConnection: ${{ parameters.ServiceConnection }}
                FunctionAppName: $(FunctionAppName)
                DeploymentPackagePath: $(Pipeline.Workspace)/$(SolutionBaseName)/$(SolutionBaseName).Jobs.zip
